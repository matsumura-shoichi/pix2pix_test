AIによるオルソ画像接合の改良の試み

　オルソ化した空中写真を接続して作成された大きなオルソ画像に、撮影時期や季節の違いによって、接合部分で色合いの違いによる違和感が発生する場合がある（図１）。
 ![image](https://github.com/user-attachments/assets/9277a2f6-632e-499e-ae57-64417d946b81)

 オルソ画像をグレースケール化し、再カラー化することにより、接合部分で違和感のない画像を作成できる可能性があると考え試行してみた。

オルソ画像としては、小田急線新百合ヶ丘駅付近のレベル17の地理院タイルを採用した。元画像のグレースケール化にはPythonのPIL (Pillow) ライブラリを使用して実施した（図２）。

![image](https://github.com/user-attachments/assets/48a34dba-3254-43d1-84fc-b5def35b120c)
![image](https://github.com/user-attachments/assets/7f14a3e3-c0af-4f6b-abd5-c7df9d5f9dab)
図２　地理院タイルとグレースケール化

グレースケール化した画像からも接合の境界がはっきり見て取れることから、カラー化の前処理として、グレースケール画像の明度・コントラスト調整を行ったほうが良好な結果が得られることが予想される（図３）。
![image](https://github.com/user-attachments/assets/575f7ef4-6b28-45ad-80ae-8c5896f95318)
![image](https://github.com/user-attachments/assets/f33fbc20-9429-49fb-a9fb-5bdc1aaf8962)
図３　グレースケール化した画像からも接合の境界がはっきり見て取れる

　以下のプロセスにより、接合の境界を挟んだ画像の明度・コントラスト調整を行った。
    • 目視による境界の設定（図４）
    • 境界両側の画素の比較による明度差・コントラスト差の推定（図５）
    • 推定したパラメータによる明度・コントラスト調整（図６）。
![image](https://github.com/user-attachments/assets/73bed933-a61f-445c-84f5-73526cb96f16)
図４　目視による境界の設定
![image](https://github.com/user-attachments/assets/778b5a8e-f5b0-41b6-b4c8-1ef2798491c3)
図５　境界両側の画素の比較による明度差・コントラスト差の推定
![image](https://github.com/user-attachments/assets/dafb7518-1318-42fd-8ad0-d24bf6c1f04a)
図６　明度・コントラスト調整（左図は調整前、右図は調整後）

　グレースケール化した画像の接合の境界を挟んだ明度・コントラスト調整は「1984から86年」の空中写真についてのみ実施した。接合の境界の自動検出が実施できなかったためである（後述）。

　グレースケール化した画像の再カラー化にはpix2pixを使用した。Pix2pixとは、条件付き生成敵対ネットワーク（cGAN）を用いて、画像から画像への変換を行う手法である。

（出典）
タイトル: "Image-to-Image Translation with Conditional Adversarial Networks"
著者: Phillip Isola, Jun-Yan Zhu, Tinghui Zhou, Alexei A. Efros
発表年: 2017

教師画像には地理院タイルズームレベル17の「全国最新の空中写真（シームレス）」441枚（21×21）を使用した（図７）。なお、地理院タイルの大きさは256ピクセル×256ピクセルである。
![image](https://github.com/user-attachments/assets/59b687f0-e2c9-48ce-9990-617b27c96501)
図７　全国最新写真を使用して学習モデル構築のための教師データを作成
（右半分は元の地理院タイル（ターゲット画像）、左半分はグレースケール化）

　テストサイト（https://matsumura-shoichi.github.io/pix2pix_test/）の作成にはLeafletを使用した。
Leafletは、オープンソースのJavaScriptライブラリであり、インタラクティブな地図をウェブアプリケーションに簡単に組み込むために広く使用されている。
テストサイトは、左側にpix2pixを用いたカラー化画像を、右側に地理院地図を配置し、上部のラジオボタンにより写真の年代を切り替えることができる。
なお、「1961年から69年」の空中写真についてはオリジナルがグレースケールであるため、カラー化のみ実施した。なお、「1984から86年」以外の空中写真については接合の境界をはさんだ明度・コントラスト調整は実施していない。

出典（文献等）
    • タイトル: "Leaflet — a JavaScript library for interactive maps"
    • 著者: Vladimir Agafonkin
    • 発表年: 2011年（初版リリース）
    • 公式サイト: Leaflet
    • GitHubリポジトリ: Leaflet GitHub

（参考）接合の境界の自動抽出の試み
　接合の境界の自動抽出をアルゴリズムによる方法とpix2pixによる方法の二種類で試みたがうまくいかなかった。

　アルゴリズムによる方法（図８）
    • ラプラスフィルターの適用: モノクロ画像にラプラスフィルターを適用してエッジを強調
    • 二値化:cv2.thresholdを使用して、ラプラスフィルターの結果を二値化（thresholdの値を40に設定）
    • ハフ変換を使用した直線検出: 二値化した画像に対して、ハフ変換を使用して直線を検出
　接合の境界を含む多数の直線成分が検出される結果となった。なお、二値化の閾値を40よりも大きくすると、接合の境界が検出されなくなってしまう。
![image](https://github.com/user-attachments/assets/960786e4-7958-4fcd-af69-a58f144226fc)
図８　左から、元画像、ラプラスフィルター適用、同左を二値化、同左にハフ変換

　Pix2pixによる方法
　以下の教師画像による学習モデルの構築。ズームレベル17の「1984年から86年」の空中写真の地理院タイルのうち、タイル内に接合の境界があるものについては、元画像と目視により設定した境界線を元画像に引いたものを並べたものを教師画像として作成した（21枚）（図９）。タイル内に接合の境界がないものはそのまま並べたものを教師画像とした（357枚）。
![image](https://github.com/user-attachments/assets/7b282437-a202-4c02-af96-a29aaff1793a)
図９　左側が元画像、右側は接合の境界に線を引いたターゲット画像

　200エポックの学習を行ったが、良好な学習結果は得られなかった（図10）。
![image](https://github.com/user-attachments/assets/e8ed354b-87eb-4bb7-8eb1-83f8507a9373)
図10　学習結果　接合の境界がない筈のタイルにも線が引かれてしまっている
